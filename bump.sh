#!/bin/bash

set -euo pipefail


#======================================================================================================================
# Get image details (call script from image directory).
#======================================================================================================================

IMAGE=`basename ${PWD}`
IMAGE_DIR=${PWD}


#======================================================================================================================
# Check the version file exists.
#======================================================================================================================

VERSION_FILE=${IMAGE_DIR}/VERSION
if [[ ! -f "${VERSION_FILE}" ]] ; then
    echo "Unable to find version file ${VERSION_FILE}."
    exit 1
fi


#======================================================================================================================
# Make sure the current branch is 'main'.
#======================================================================================================================

cd ${IMAGE_DIR}
git pull

CURRENT_BRANCH=`git rev-parse --abbrev-ref HEAD`
if [[ "${CURRENT_BRANCH}" != "main" ]] ; then
    echo "Current branch is not 'main'."
    exit 1
fi


#======================================================================================================================
# Get the current and new versions.
#======================================================================================================================

CURRENT_VERSION=`cat ${VERSION_FILE}`
A=(${CURRENT_VERSION//./ })

NEW_VERSION="${A[0]}.${A[1]}.$((++A[2]))"
echo "Updating ${IMAGE} from ${CURRENT_VERSION} to ${NEW_VERSION}."


#======================================================================================================================
# Create a new branch.
#======================================================================================================================

git pull

NEW_BRANCH="v${NEW_VERSION}"
git branch ${NEW_BRANCH}
git checkout ${NEW_BRANCH}


#======================================================================================================================
# Update VERSION and commit.
#======================================================================================================================

printf "%s" ${NEW_VERSION} > VERSION
git add VERSION

export GPG_TTY=$(tty)
git commit --message "Bumping version to ${NEW_VERSION}"


#======================================================================================================================
# Done!
#======================================================================================================================

echo "Done."
